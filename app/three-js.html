<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/threejs/build/three.js"></script>

<polymer-element name="three-js" attributes="canvas,width,height">
  <script>
    Polymer({
      isSetup: false,
      domReady: function() {
        if (typeof this.parentNode.tagName === 'undefined') return; // #shadowroot
        this.setup();
        this.start();
      },
      setup: function() {
        if (this.isSetup) return;
        if (this.canvas) {
          this.canvas = document.getElementById(this.canvas);
        }
        else if (this.previousElementSibling && this.previousElementSibling.tagName === 'CANVAS') {
          this.canvas = this.previousElementSibling;
        }
        else {
          if (typeof this.width === 'undefined' || typeof this.height === 'undefined') {
            throw 'no canvas';
          }
          this.canvas = document.createElement('canvas');
          this.canvas.width = this.width;
          this.canvas.height = this.height;
          this.parentNode.insertBefore(this.canvas, this);
        }

        var rendererElm = this.querySelector('three-js-renderer');
        rendererElm.setup(this);
        this.renderer = rendererElm.renderer;

        var sceneElm = this.querySelector('three-js-scene');
        sceneElm.setup(this);
        this.scene = sceneElm.scene;

        if (typeof rendererElm.cameraId === 'undefined') {
          this.scene.children.forEach(function(child) {
            if (child instanceof THREE.Camera) {
              this.camera = child;
            }
          }.bind(this));
        }
        else {
          var cameraId = rendererElm.cameraId;
          var cameraElm = sceneElm.querySelector('#' + cameraId);
          cameraElm.setup(this);
          this.camera = cameraElm.camera;
        }
        if (typeof this.camera === 'undefined') throw 'no camera';

        this.isSetup = true;
      },
      render: function() {
        this.renderer.render(this.scene, this.camera);
      },
      start: function() {
        ((function animate() {
          requestAnimationFrame(animate.bind(this));
          this.render();
          this.scene.children.forEach(function(child) {
            if (typeof child.userData.element !== 'undefined') {
              child.userData.element.fire('render');
            }
          });
        }).bind(this))();
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-renderer" attributes="antialias,clearColor,sceneId,cameraId">
  <script>
    Polymer({
      isSetup: false,
      setup: function(threejs) {
        if (this.isSetup) return;
        this.canvas = threejs.canvas;
        var antialias = this.antialias !== undefined;
        var clearColor = new THREE.Color(this.clearColor || '#000000');
        this.renderer = new THREE.WebGLRenderer({canvas:this.canvas, antialias:antialias});
        this.renderer.setClearColor(clearColor, 1);
        this.isSetup = true;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-scene">
  <script>
    Polymer({
      isSetup: false,
      setup: function(threejs) {
        if (this.isSetup) return;
        this.scene = new THREE.Scene();
        Array.apply(null, this.children).forEach(function(child) {
          if (child.setup) child.setup(threejs);
          if (child.object) this.scene.add(child.object);
          // TODO: 後でリファクタリング
          if (child.getDistributedNodes) {
            Array.apply(null, child.getDistributedNodes()).forEach(function(contentChild) {
              if (contentChild.setup) contentChild.setup(threejs);
              if (contentChild.object) this.scene.add(contentChild.object);
            }, this);
          }
        }, this);
        this.isSetup = true;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-object3d" attributes="position,rotation">
  <script>
    Polymer({
      isSetup: false,
      setup: function() {
      },
      ready: function() {
        this.position = this.vector3(this.position);
        this.rotation = this.euler(this.rotation);
      },
      vector3: function(val) {
        if (typeof val === 'undefined') {
          return new THREE.Vector3();
        }
        else if (val instanceof THREE.Vector3) {
          return val;
        }
        else if (typeof val === 'string') { // ex) 1,2,3
          var vals = eval('[' + val + ']');
          return new THREE.Vector3(vals[0], vals[1], vals[2]);
        }
        else {
          console.log('invalid argument: ', val);
          throw 'invalid argument: ' + val;
        }
      },
      euler: function(val) {
        if (typeof val === 'undefined') {
          return new THREE.Euler();
        }
        else if (val instanceof THREE.Euler) {
          return val;
        }
        else if (typeof val === 'string') { // ex) 1,2,3
          var vals = eval('[' + val + ']');
          return new THREE.Euler(vals[0], vals[1], vals[2], vals[3]);
        }
        else {
          console.log('invalid argument: ', val);
          throw 'invalid argument: ' + val;
        }
      },
      positionChanged: function(oldVal, newVal) {
        this.position = this.vector3(newVal);
        if (typeof this.object !== 'undefined') {
          this.object.position.copy(this.position);
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-camera" extends="three-js-object3d" attributes="lookAt">
  <script>
    Polymer({
      setup: function(threejs) {
        if (this.isSetup) return;
        var aspect = threejs.canvas.width / threejs.canvas.height;
        this.camera = new THREE.PerspectiveCamera(15, aspect);
        this.camera.userData['element'] = this;
        this.camera.position.copy(this.vector3(this.position));
        this.camera.lookAt(this.vector3(this.lookAt));
        this.object = this.camera;
        this.isSetup = true;
      },
      lookAtChanged: function(oldVal, newVal) {
        if (typeof this.camera !== 'undefined') {
          this.camera.lookAt(this.vector3(newVal));
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-canvas" attributes="width,height,antialias,clearColor">
  <template>
    <three-js width="{{width}}" height="{{height}}">
      <three-js-renderer antialias={{antialias}} clearColor="{{clearColor}}"></three-js-renderer>
      <three-js-scene>
        <content></content>
      </three-js-scene>
    </three-js>
  </template>
  <script>
    Polymer({
      domReady: function() {
        var threejs = this.shadowRoot.children[0];
        threejs.setup();
        threejs.start();
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-light" extends="three-js-object3d" attributes="direction,ambient,color">
  <script>
    Polymer({
      ready: function() {
        this.setup();
      },
      setup: function() {
        if (this.isSetup) return;
        var color = new THREE.Color(this.color || '#ffffff');
        if (this.direction) {
          var direction = eval("[" + this.direction + "]");
          this.light = new THREE.DirectionalLight(color);
          this.light.position.set(direction[0], direction[1], direction[2]);
        }
        else if (this.ambient !== undefined) {
          this.light = new THREE.AmbientLight(color);
        }
        this.object = this.light;
        this.isSetup = true;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-mesh" extends="three-js-object3d">
  <script>
    Polymer({
      setup: function() {
        var material;
        var geometries = [];
        Array.apply(null, this.children).forEach(function(child) {
          if (child.material) material = child.material;
          if (child.geometry) geometries.push(child.geometry);
        });
        this.mesh = new THREE.Mesh(geometries[0], material);
        this.mesh.userData['element'] = this;
        this.mesh.position.copy(this.position);
        this.object = this.mesh;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-material" attributes="color,map,type">
  <script>
    Polymer({
      type: 'MeshPhongMaterial',
      ready: function() {
        this.setup();
      },
      setup: function() {
        var color = new THREE.Color(this.color || '#ffffff');
        this.material = new THREE[this.type]({color: color});
        if (typeof this.map !== 'undefined') {
          this.material.map = THREE.ImageUtils.loadTexture(this.map);
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-geomerty">
  <script>
    Polymer({
    });
  </script>
</polymer-element>

<!-- TODO: phiStart,phiLength,thetaStart,thetaLength -->
<polymer-element name="three-js-sphere-geometry" extends="three-js-geomerty" attributes="radius,widthSegments,heightSegments,phiStart,phiLength,thetaStart,thetaLength">
  <script>
    Polymer({
      widthSegments: '32',
      heightSegments: '16',
      ready: function() {
        this.setup();
      },
      setup: function() {
        var radius = parseFloat(this.radius || '1');
        var widthSegments = parseInt(this.widthSegments, 10);
        var heightSegments = parseInt(this.heightSegments, 10);
        this.geometry = new THREE.SphereGeometry(radius, widthSegments, heightSegments);
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-js-sphere" extends="three-js-object3d" attributes="radius,color,map">
  <template>
    <three-js-mesh position="{{position}}">
      <three-js-material color="{{color}}" map="{{map}}"></three-js-material>
      <three-js-sphere-geometry radius="{{radius}}"></three-js-sphere-geometry>
    </three-js-mesh>
  </template>
  <script>
    Polymer({
      setup: function(threejs) {
        var child = this.shadowRoot.children[0];
        child.setup(threejs);
        this.object = child.object
        this.mesh = this.object;
        this.mesh.userData['element'] = this;
      }
    });
  </script>
</polymer-element>
