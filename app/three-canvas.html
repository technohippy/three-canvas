<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/threejs/build/three.js"></script>

<script src="bower_components/three.js-controls/src/FirstPersonControls.js"></script>
<script src="bower_components/three.js-controls/src/FlyControls.js"></script>
<script src="bower_components/three.js-controls/src/OrbitControls.js"></script>

<script>
  THREE.Element = THREE.Element || {Utils:{}};
  THREE.Element.Utils.vector3 = function(val) {
    if (typeof val === 'undefined') {
      return new THREE.Vector3();
    }
    else if (val instanceof THREE.Vector3) {
      return val;
    }
    else if (typeof val === 'string') { // ex) 1,2,3
      try {
        var vals = eval('[' + val + ']');
        return new THREE.Vector3(vals[0], vals[1], vals[2]);
      }
      catch (e) {
        console.log('invalid args: ' + val);
        throw e;
      }
    }
    else {
      console.log('invalid argument: ', val);
      throw 'invalid argument: ' + val;
    }
  };
  THREE.Element.Utils.euler = function(val) {
    if (typeof val === 'undefined') {
      return new THREE.Euler();
    }
    else if (val instanceof THREE.Euler) {
      return val;
    }
    else if (typeof val === 'string') { // ex) 1,2,3
      try {
        var vals = eval('[' + val + ']');
        return new THREE.Euler(vals[0], vals[1], vals[2], vals[3]);
      }
      catch (e) {
        console.log('invalid args: ' + val);
        throw e;
      }
    }
    else {
      console.log('invalid argument: ', val);
      throw 'invalid argument: ' + val;
    }
  };
</script>

<polymer-element name="three-engine" attributes="canvas,width,height,fullscreen">
  <script>
    Polymer({
      isSetup: false,
      domReady: function() {
        if (typeof this.parentNode.tagName === 'undefined') return; // #shadowroot
        this.setup();
        this.start();
      },
      setup: function() {
        if (this.isSetup) return;
        var isFullscreen = this.fullscreen || this.fullscreen === '';
        if (this.canvas) {
          this.canvas = document.getElementById(this.canvas);
        }
        else if (this.previousElementSibling && this.previousElementSibling.tagName === 'CANVAS') {
          this.canvas = this.previousElementSibling;
        }
        else {
          if (typeof this.width === 'undefined' || typeof this.height === 'undefined') {
            if (isFullscreen) {
              this.width = window.innerWidth;
              this.height = window.innerHeight;
            }
            else {
              throw 'no canvas';
            }
          }
          this.canvas = document.createElement('canvas');
          this.canvas.width = this.width;
          this.canvas.height = this.height;
          if (isFullscreen) {
            this.canvas.style.margin = 0;
            this.canvas.style.padding = 0;
            this.canvas.style.position = 'absolute';
            this.canvas.style.top = 0;
            this.canvas.style.left = 0;
          }
          this.parentNode.insertBefore(this.canvas, this);
        }

        var rendererElm = this.querySelector('three-renderer');
        rendererElm.setup(this);
        this.renderer = rendererElm.renderer;

        var sceneElm = this.querySelector('three-scene');
        sceneElm.setup(this);
        this.scene = sceneElm.scene;

        if (typeof rendererElm.cameraId === 'undefined') {
          this.scene.children.forEach(function(child) {
            if (child instanceof THREE.Camera) {
              this.camera = child;
            }
          }.bind(this));
        }
        else {
          var cameraId = rendererElm.cameraId;
          var cameraElm = sceneElm.querySelector('#' + cameraId);
          cameraElm.setup(this);
          this.camera = cameraElm.camera;
        }
        if (typeof this.camera === 'undefined') throw 'no camera';
        if (typeof this.camera.userData['element'] !== 'undefined') {
          var controlsElm = this.camera.userData['element'].querySelector('three-controls');
          if (controlsElm) {
            controlsElm.setup(this.camera, this.canvas);
            this.controls = controlsElm.controls;
          }
        }

        this.isSetup = true;
      },
      render: function() {
        this.renderer.render(this.scene, this.camera);
      },
      start: function() {
        if (this.fullscreen || this.fullscreen === '') {
          window.addEventListener('resize', function() {
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
          }.bind(this), false);
        }

        var clock = new THREE.Clock();
        ((function animate() {
          requestAnimationFrame(animate.bind(this));
          this.render();
          this.scene.children.forEach(function(child) {
            if (typeof child.userData.element !== 'undefined') {
              child.userData.element.fire('render');
            }
          });
          if (this.controls) this.controls.update(clock.getDelta());
        }).bind(this))();
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-renderer" attributes="antialias,clearColor,sceneId,cameraId">
  <script>
    Polymer({
      isSetup: false,
      setup: function(threejs) {
        if (this.isSetup) return;
        this.canvas = threejs.canvas;
        var antialias = this.antialias !== undefined;
        var clearColor = new THREE.Color(this.clearColor || '#000000');
        this.renderer = new THREE.WebGLRenderer({canvas:this.canvas, antialias:antialias});
        this.renderer.setClearColor(clearColor, 1);
        this.isSetup = true;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-scene" attributes="defaultLight">
  <script>
    Polymer({
      isSetup: false,
      setup: function(threejs) {
        if (this.isSetup) return;

        this.scene = new THREE.Scene();

        Array.apply(null, this.children).forEach(function(child) {
          if (child.setup) child.setup(threejs);
          if (child.object) this.scene.add(child.object);
          // TODO: 後でリファクタリング
          if (child.getDistributedNodes) {
            Array.apply(null, child.getDistributedNodes()).forEach(function(contentChild) {
              if (contentChild.setup) contentChild.setup(threejs);
              if (contentChild.object) this.scene.add(contentChild.object);
            }, this);
          }
        }, this);

        this.isSetup = true;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-object3d" attributes="position,rotation,scale,castShadow,receiveShadow">
  <script>
    Polymer({
      isSetup: false,
      castShadow: false,
      receiveShadow: false,
      scale: '1,1,1',
      setup: function() {
      },
      ready: function() {
        this.position = this.vector3(this.position);
        this.rotation = this.euler(this.rotation);
        this.scale = this.vector3(this.scale);
      },
      vector3: function(val) {
        return THREE.Element.Utils.vector3(val);
      },
      euler: function(val) {
        return THREE.Element.Utils.euler(val);
      },
      positionChanged: function(oldVal, newVal) {
        this.position = this.vector3(newVal);
        if (typeof this.object !== 'undefined') {
          this.object.position.copy(this.position);
        }
      },
      rotationChanged: function(oldVal, newVal) {
        this.rotation = this.euler(newVal);
        if (typeof this.object !== 'undefined') {
          this.object.rotation.copy(this.rotation);
        }
      },
      scaleChanged: function(oldVal, newVal) {
        this.scale = this.vector3(newVal);
        if (typeof this.object !== 'undefined') {
          this.object.scale.copy(this.scale);
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-camera" extends="three-object3d" attributes="lookAt,controls">
  <script>
    Polymer({
      setup: function(threejs) {
        if (this.isSetup) return;
        var aspect = threejs.canvas.width / threejs.canvas.height;
        this.camera = new THREE.PerspectiveCamera(15, aspect);
        this.camera.userData['element'] = this;
        this.camera.position.copy(this.vector3(this.position));
        this.camera.lookAt(this.vector3(this.lookAt));
        this.object = this.camera;
        this.isSetup = true;

        if (this.controls === 'orbit') {
          var controlsElm = document.createElement('three-controls');
          controlsElm.setAttribute('type', 'orbit');
          controlsElm.setAttribute('center', this.lookAt);
          this.appendChild(controlsElm);
        }
        else if (this.controls === 'fly') {
          var controlsElm = document.createElement('three-controls');
          controlsElm.setAttribute('type', 'fly');
          this.appendChild(controlsElm);
        }
        else if (this.controls === 'firstperson') {
          var controlsElm = document.createElement('three-controls');
          controlsElm.setAttribute('type', 'firstperson');
          this.appendChild(controlsElm);
        }
      },
      lookAtChanged: function(oldVal, newVal) {
        if (typeof this.camera !== 'undefined') {
          this.camera.lookAt(this.vector3(newVal));
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-canvas" attributes="width,height,antialias,clearColor,fullscreen,defaultLight">
  <template>
    <three-engine fullscreen={{fullscreen}} width="{{width}}" height="{{height}}">
      <three-renderer antialias={{antialias}} clearColor="{{clearColor}}"></three-renderer>
      <three-scene id="scene" defaultLight={{defaultLight}}>
        <content></content>
      </three-scene>
    </three-engine>
  </template>
  <script>
    Polymer({
      needDefaultLight: false,
      domReady: function() {
        if (this.querySelector('three-light') === null && this.defaultLight !== 'false') {
          /*
          <template if={{needDefaultLight}}>
            <three-light direction="0.577,0.577,0.577" color="#cccccc"></three-light>
            <three-light ambient color="#333333"></three-light>
          </template>
          this.needDefaultLight = true;
          */
          var directionalLight = document.createElement('three-light');
          directionalLight.setAttribute('direction', '0.577,0.577,0.577');
          directionalLight.setAttribute('color', '#cccccc');
          directionalLight.isSetup = false;
          this.$.scene.appendChild(directionalLight);
          var ambientLight = document.createElement('three-light');
          ambientLight.setAttribute('ambient', '');
          ambientLight.setAttribute('color', '#333333');
          ambientLight.isSetup = false;
          this.$.scene.appendChild(ambientLight);
        }
        var threejs = this.shadowRoot.children[0];
        threejs.setup();
        threejs.start();
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-light" extends="three-object3d" attributes="direction,ambient,color">
  <script>
    Polymer({
      ready: function() {
        this.setup();
      },
      setup: function() {
        if (this.isSetup) return;
        var color = new THREE.Color(this.color || '#ffffff');
        if (this.direction) {
          var direction = eval("[" + this.direction + "]");
          this.light = new THREE.DirectionalLight(color);
          this.light.position.set(direction[0], direction[1], direction[2]);
        }
        else if (this.ambient !== undefined) {
          this.light = new THREE.AmbientLight(color);
        }
        this.object = this.light;
        this.isSetup = true;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-mesh" extends="three-object3d">
  <script>
    Polymer({
      setup: function() {
        var material;
        var geometries = [];
        Array.apply(null, this.children).forEach(function(child) {
          if (child.material) material = child.material;
          if (child.geometry) geometries.push(child.geometry);
          // TODO: 後でリファクタリング
          if (child.getDistributedNodes) {
            Array.apply(null, child.getDistributedNodes()).forEach(function(contentChild) {
              if (contentChild.material) material = contentChild.material;
              if (contentChild.geometry) geometries.push(contentChild.geometry);
            }, this);
          }
        });
        this.mesh = new THREE.Mesh(geometries[0], material);
        this.mesh.userData['element'] = this;
        this.mesh.position.copy(this.position);
        this.mesh.rotation.copy(this.rotation);
        this.mesh.scale.copy(this.scale);
        this.object = this.mesh;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-material" attributes="side,opacity,transparent,blending,blendSrc,blendDst,blendEquation,depthTest,depthWrite,polygonOffset,polygonOffsetFactor,polygonOffsetUnits,alphaTest,overdraw,visible">
  <script>
    Polymer({
      side: THREE.FrontSide,
      opacity: 1,
      transparent: false,
      blending: THREE.NormalBlending,
      blendSrc: THREE.SrcAlphaFactor,
      blendDst: THREE.OneMinusSrcAlphaFactor,
      blendEquation: THREE.AddEquation,
      depthTest: true,
      depthWrite: true,
      polygonOffset: false,
      polygonOffsetFactor: 0,
      polygonOffsetUnits: 0,
      alphaTest: 0,
      overdraw: 0,
      visible: true,
      getOptions: function() {
        if (this.opacity < 1) this.transparent = true;
        return {
          side: this.side,
          opacity: this.opacity,
          transparent: this.transparent,
          blending: this.blending,
          blendSrc: this.blendSrc,
          blendDst: this.blendDst,
          blendEquation: this.blendEquation,
          depthTest: this.depthTest,
          depthWrite: this.depthWrite,
          polygonOffset: this.polygonOffset,
          polygonOffsetFactor: this.polygonOffsetFactor,
          polygonOffsetUnits: this.polygonOffsetUnits,
          alphaTest: this.alphaTest,
          overdraw: this.overdraw,
          visible: this.visible
        };
      },
      opacityChanged: function(oldVal, newVal) {
        if (newVal < 1) this.material.transparent = true;
        this.material.opacity = newVal;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-mesh-phong-material" extends="three-material" attributes="color,ambient,emissive,specular,shininess,metal,map,bumpMap,bumpScale,fog,shading,wireframe">
  <script>
    Polymer({
      color: '#ffffff',
      ambient: '#ffffff',
      emissive: '#000000',
      specular: '#000000',
      shininess: 30,
      metal: false,
      bumpScale: 1,
      fog: true,
      shading: THREE.SmoothShading,
      wireframe: false,
      ready: function() {
        this.setup();
      },
      setup: function() {
        this.material = new THREE.MeshPhongMaterial(this.getOptions());
        if (typeof this.map !== 'undefined') {
          this.material.map = THREE.ImageUtils.loadTexture(this.map);
        }
        if (typeof this.bumpMap !== 'undefined') {
          this.material.bumpMap = THREE.ImageUtils.loadTexture(this.bumpMap);
        }
      },
      getOptions: function() {
        var opts = this.super();
        opts['color'] = new THREE.Color(this.color);
        opts['ambient'] = new THREE.Color(this.ambient);
        opts['emissive'] = new THREE.Color(this.emissive);
        opts['specular'] = new THREE.Color(this.specular);
        opts['shininess'] = this.shininess;
        opts['metal'] = this.metal;
        opts['bumpScale'] = this.bumpScale;
        opts['fog'] = this.fog;
        opts['shading'] = this.shading;
        opts['wireframe'] = this.wireframe;
        return opts;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-geomerty">
  <script>
    Polymer({
    });
  </script>
</polymer-element>

<!-- TODO: phiStart,phiLength,thetaStart,thetaLength -->
<polymer-element name="three-sphere-geometry" extends="three-geomerty" attributes="radius,widthSegments,heightSegments,phiStart,phiLength,thetaStart,thetaLength">
  <script>
    Polymer({
      widthSegments: '32',
      heightSegments: '16',
      ready: function() {
        this.setup();
      },
      setup: function() {
        var radius = parseFloat(this.radius || '1');
        var widthSegments = parseInt(this.widthSegments, 10);
        var heightSegments = parseInt(this.heightSegments, 10);
        this.geometry = new THREE.SphereGeometry(radius, widthSegments, heightSegments);
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-box-geometry" extends="three-geomerty" attributes="width,height,depth,widthSegments,heightSegments,depthSegments">
  <script>
    Polymer({
      widthSegments: '1',
      heightSegments: '1',
      depthSegments: '1',
      ready: function() {
        this.setup();
      },
      setup: function() {
        var width = parseFloat(this.width || '1');
        var height = parseFloat(this.height || '1');
        var depth = parseFloat(this.depth || '1');
        var widthSegments = parseInt(this.widthSegments, 10);
        var heightSegments = parseInt(this.heightSegments, 10);
        var depthSegments = parseInt(this.depthSegments, 10);
        this.geometry = new THREE.BoxGeometry(width, height, depth, widthSegments, heightSegments, depthSegments);
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-mesh-phong-materialized-mesh" extends="three-object3d" attributes="side,opacity,transparent,blending,blendSrc,blendDst,blendEquation,depthTest,depthWrite,polygonOffset,polygonOffsetFactor,polygonOffsetUnits,alphaTest,overdraw,visible,color,ambient,emissive,specular,shininess,metal,map,bumpMap,bumpScale,fog,shading,wireframe">
  <template>
    <three-mesh position="{{position}}" rotation="{{rotation}}" scale="{{scale}}">
      <three-mesh-phong-material
        side="{{side}}"
        opacity="{{opacity}}"
        transparent="{{transparent}}"
        blending="{{blending}}"
        blendSrc="{{blendSrc}}"
        blendDst="{{blendDst}}"
        blendEquation="{{blendEquation}}"
        depthTest="{{depthTest}}"
        depthWrite="{{depthWrite}}"
        polygonOffset="{{polygonOffset}}"
        polygonOffsetFactor="{{polygonOffsetFactor}}"
        polygonOffsetUnits="{{polygonOffsetUnits}}"
        alphaTest="{{alphaTest}}"
        overdraw="{{overdraw}}"
        visible="{{visible}}"
        color="{{color}}"
        ambient="{{ambient}}"
        emissive="{{emissive}}"
        specular="{{specular}}"
        shininess="{{shininess}}"
        metal="{{metal}}"
        map="{{map}}"
        bumpMap="{{bumpMap}}"
        bumpScale="{{bumpScale}}"
        fog="{{fog}}"
        shading="{{shading}}"
        wireframe="{{wireframe}}">
      </three-mesh-phong-material>
      <content></content>
    </three-mesh>
  </template>
  <script>
    Polymer({
    });
  </script>
</polymer-element>

<polymer-element name="three-sphere" extends="three-mesh-phong-materialized-mesh" attributes="radius">
  <template>
    <three-mesh-phong-materialized-mesh
      position="{{position}}"
      rotation="{{rotation}}"
      scale="{{scale}}"
      side="{{side}}"
      opacity="{{opacity}}"
      transparent="{{transparent}}"
      blending="{{blending}}"
      blendSrc="{{blendSrc}}"
      blendDst="{{blendDst}}"
      blendEquation="{{blendEquation}}"
      depthTest="{{depthTest}}"
      depthWrite="{{depthWrite}}"
      polygonOffset="{{polygonOffset}}"
      polygonOffsetFactor="{{polygonOffsetFactor}}"
      polygonOffsetUnits="{{polygonOffsetUnits}}"
      alphaTest="{{alphaTest}}"
      overdraw="{{overdraw}}"
      visible="{{visible}}"
      color="{{color}}"
      ambient="{{ambient}}"
      emissive="{{emissive}}"
      specular="{{specular}}"
      shininess="{{shininess}}"
      metal="{{metal}}"
      map="{{map}}"
      bumpMap="{{bumpMap}}"
      bumpScale="{{bumpScale}}"
      fog="{{fog}}"
      shading="{{shading}}"
      wireframe="{{wireframe}}">
      <three-sphere-geometry radius="{{radius}}"></three-sphere-geometry>
    </three-mesh-phong-materialized-mesh>
  </template>
  <script>
    Polymer({
      setup: function(threejs) {
        var child = this.shadowRoot.children[0].shadowRoot.children[0];
        child.setup(threejs);
        this.object = child.object
        this.mesh = this.object;
        this.mesh.userData['element'] = this;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-box" extends="three-mesh-phong-materialized-mesh" attributes="width,height,depth">
  <template>
    <three-mesh-phong-materialized-mesh
      position="{{position}}"
      rotation="{{rotation}}"
      scale="{{scale}}"
      side="{{side}}"
      opacity="{{opacity}}"
      transparent="{{transparent}}"
      blending="{{blending}}"
      blendSrc="{{blendSrc}}"
      blendDst="{{blendDst}}"
      blendEquation="{{blendEquation}}"
      depthTest="{{depthTest}}"
      depthWrite="{{depthWrite}}"
      polygonOffset="{{polygonOffset}}"
      polygonOffsetFactor="{{polygonOffsetFactor}}"
      polygonOffsetUnits="{{polygonOffsetUnits}}"
      alphaTest="{{alphaTest}}"
      overdraw="{{overdraw}}"
      visible="{{visible}}"
      color="{{color}}"
      ambient="{{ambient}}"
      emissive="{{emissive}}"
      specular="{{specular}}"
      shininess="{{shininess}}"
      metal="{{metal}}"
      map="{{map}}"
      bumpMap="{{bumpMap}}"
      bumpScale="{{bumpScale}}"
      fog="{{fog}}"
      shading="{{shading}}"
      wireframe="{{wireframe}}">
      <three-box-geometry width="{{width}}" height="{{height}}" depth="{{depth}}"></three-box-geometry>
    </three-mesh-phong-materialized-mesh>
  </template>
  <script>
    Polymer({
      setup: function(threejs) {
        var child = this.shadowRoot.children[0].shadowRoot.children[0];
        child.setup(threejs);
        this.object = child.object
        this.mesh = this.object;
        this.mesh.userData['element'] = this;
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-controls" attributes="type,center,movementSpeed,rollSpeed,lookSpeed,lon,noFly">
  <script>
    Polymer({
      setup: function(camera, canvas) {
        if (this.type === 'orbit') {
          this.controls = new THREE.OrbitControls(camera, canvas);
          this.controls.center = THREE.Element.Utils.vector3(this.center);
        }
        else if (this.type === 'fly') {
          this.controls = new THREE.FlyControls(camera, canvas);
          if (typeof this.movementSpeed !== 'undefined') {
            this.controls.movementSpeed = parseFloat(this.movementSpeed);
          }
          if (typeof this.rollSpeed !== 'undefined') {
            this.controls.rollSpeed = parseFloat(this.rollSpeed);
          }
        }
        else if (this.type === 'firstperson') {
          this.controls = new THREE.FirstPersonControls(camera, canvas);
          if (typeof this.movementSpeed !== 'undefined') {
            this.controls.movementSpeed = parseFloat(this.movementSpeed);
          }
          if (typeof this.lookSpeed !== 'undefined') {
            this.controls.lookSpeed = parseFloat(this.lookSpeed);
          }
          if (typeof this.lon !== 'undefined') {
            this.controls.lon = parseFloat(this.lon);
          }
          if (typeof this.noFly !== 'undefined') {
            this.controls.noFly = this.noFly === 'true';
          }
          console.log(this.controls.movementSpeed, this.controls.lookSpeed, this.controls.lon);
        }
        else {
          throw 'Unknown type: ' + this.type;
        }
      }
    });
  </script>
</polymer-element>
